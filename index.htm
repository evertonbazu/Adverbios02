<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz dos Adv√©rbios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #B0E0E6);
            touch-action: manipulation;
            overflow: hidden;
        }
        .option-button {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .option-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .option-button:active {
            transform: scale(0.98);
        }
        #feedback {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .screen {
            min-height: 100vh;
            width: 100%;
            padding: 1rem;
        }
        .video-container { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            max-width: 100%; 
            background: #000; 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        .video-container iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .heart {
            color: red;
            font-size: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- Tela de Login / Cadastro -->
    <div id="login-screen" class="screen flex items-center justify-center">
        <div class="bg-white/70 p-6 sm:p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <div id="login-form">
                <h1 class="text-3xl sm:text-4xl font-bold text-sky-800">Acessar Jogo</h1>
                <p class="text-lg text-sky-700 mt-4">Digite seu c√≥digo e senha para entrar. Se for seu primeiro acesso, crie um c√≥digo e clique em "Entrar".</p>
                <input type="text" id="login-code" placeholder="Seu c√≥digo (Ex.: 36123.16)" class="mt-8 w-full text-xl p-3 rounded-xl border-4 border-sky-300">
                <input type="password" id="login-password" placeholder="Sua senha" class="mt-4 w-full text-xl p-3 rounded-xl border-4 border-sky-300">
                <button id="login-button" class="mt-6 w-full bg-blue-500 text-white text-2xl font-bold py-3 rounded-xl shadow-lg hover:bg-blue-600 transition flex items-center justify-center">
                    <span class="button-text">Entrar</span>
                    <div class="loader hidden ml-3"></div>
                </button>
                <p id="login-message" class="text-red-500 mt-4 h-5"></p>
                <button id="go-to-register" class="mt-2 text-sky-600 hover:underline">N√£o tenho cadastro</button>
            </div>
            <div id="register-form" class="hidden">
                <h1 class="text-3xl sm:text-4xl font-bold text-sky-800">Criar Cadastro</h1>
                <p class="text-lg text-sky-700 mt-4">Preencha seus dados para criar um acesso.</p>
                <input type="text" id="register-name" placeholder="Nome Completo" class="mt-8 w-full text-xl p-3 rounded-xl border-4 border-sky-300">
                <select id="register-class" class="mt-4 w-full text-xl p-3 rounded-xl border-4 border-sky-300 bg-white">
                    <option value="">Selecione sua turma</option>
                    <option value="5¬∫ Ano A">5¬∫ Ano A</option>
                    <option value="5¬∫ Ano B">5¬∫ Ano B</option>
                </select>
                <input type="text" id="register-code" placeholder="Crie um c√≥digo de acesso" class="mt-4 w-full text-xl p-3 rounded-xl border-4 border-sky-300">
                <input type="password" id="register-password" placeholder="Crie uma senha" class="mt-4 w-full text-xl p-3 rounded-xl border-4 border-sky-300">
                <button id="register-button" class="mt-6 w-full bg-green-500 text-white text-2xl font-bold py-3 rounded-xl shadow-lg hover:bg-green-600 transition flex items-center justify-center">
                    <span class="button-text">Cadastrar e Entrar</span>
                    <div class="loader hidden ml-3"></div>
                </button>
                <p id="register-message" class="text-red-500 mt-4 h-5"></p>
                <button id="back-to-login" class="mt-2 text-sky-600 hover:underline">J√° tenho cadastro</button>
            </div>
        </div>
    </div>

    <!-- Tela do V√≠deo -->
    <div id="video-screen" class="screen hidden flex items-center justify-center">
        <div class="bg-white/70 p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full text-center">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-sky-800">Vamos aprender!</h2>
            <p class="text-base sm:text-lg text-sky-700 mt-2 mb-2">Assista ao v√≠deo para revisar e ganhar at√© 200 pontos!</p>
            <div class="mb-4 bg-white/50 rounded-full px-6 py-2 inline-block">
                <span class="text-2xl font-semibold text-sky-800">Pontos: <span class="score-display">0</span></span>
            </div>
            <div class="video-container">
                <div id="player"></div>
            </div>
            <button id="continue-btn" class="mt-8 w-full bg-green-500 text-white text-2xl sm:text-3xl font-bold py-3 sm:py-4 rounded-xl shadow-lg transition transform hover:scale-105 opacity-50 cursor-not-allowed" disabled>
                Ir para o Jogo!
            </button>
        </div>
    </div>

    <!-- Tela do Jogo -->
    <div id="game-screen" class="screen hidden w-full max-w-4xl mx-auto flex-col items-center justify-center">
        <header class="text-center mb-4 sm:mb-8 w-full">
            <div class="flex justify-between items-center w-full">
                <div id="lives-container" class="flex space-x-1"></div>
                <div class="bg-white/50 rounded-full px-4 sm:px-6 py-2">
                    <span class="text-xl sm:text-2xl font-semibold text-sky-800">Pontos: <span class="score-display">0</span></span>
                </div>
            </div>
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mt-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                Quiz dos Adv√©rbios
            </h1>
        </header>
        <main class="w-full bg-white/70 p-6 sm:p-8 rounded-2xl shadow-xl text-center">
            <div id="question-container" class="mb-6 sm:mb-8 text-xl sm:text-2xl md:text-3xl font-semibold text-sky-800 min-h-[6rem] flex items-center justify-center">
                <!-- Question will be inserted here -->
            </div>
            <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <!-- Options will be inserted here -->
            </div>
        </main>
    </div>

    <!-- Tela Final (Game Over) -->
    <div id="end-screen" class="screen hidden flex items-center justify-center">
        <div class="bg-white/70 p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-800">Fim de Jogo!</h1>
            <p id="final-message" class="text-lg text-sky-800 mt-4 font-semibold"></p>
            <div class="flex justify-around items-center my-6 text-sky-700">
                <div class="text-xl"><strong>Pontos:</strong> <span id="final-score">0</span></div>
                <div class="text-xl"><strong>Tempo:</strong> <span id="final-time">0s</span></div>
            </div>
            <h2 class="text-2xl sm:text-3xl font-bold text-sky-800 mt-6 mb-4">Ranking (Top 100)</h2>
            <div class="overflow-y-auto h-64 bg-white/50 rounded-lg">
                <table class="w-full text-left">
                    <thead class="bg-sky-200 sticky top-0">
                        <tr>
                            <th class="p-2">#</th>
                            <th class="p-2">Nome</th>
                            <th class="p-2">Pontos</th>
                            <th class="p-2">Turma</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <tr><td colspan="4" class="p-8 text-center"><div class="loader mx-auto"></div></td></tr>
                    </tbody>
                </table>
            </div>
            <button id="play-again-button" class="mt-8 w-full bg-yellow-500 text-white text-2xl sm:text-3xl font-bold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition">
                Jogar Novamente
            </button>
        </div>
    </div>

    <div id="feedback" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 sm:p-8 rounded-2xl text-white text-2xl sm:text-3xl font-bold shadow-2xl opacity-0 pointer-events-none w-11/12 max-w-sm text-center"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- CONFIGURA√á√ÉO ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvzdtou17UCu8lmOFg9fxVEaLg1FnWcvexCYUZzqNLcUhiE6mZW_OkxeeI874AXZRT/exec';
        const NOME_DESTE_JOGO = "Quiz dos Adv√©rbios"; // Nome do jogo para o ranking

        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const videoScreen = document.getElementById('video-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const continueBtn = document.getElementById('continue-btn');
        const loginForm = document.getElementById('login-form');
        const loginCodeInput = document.getElementById('login-code');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginMessage = document.getElementById('login-message');
        const goToRegisterButton = document.getElementById('go-to-register');
        const registerForm = document.getElementById('register-form');
        const registerNameInput = document.getElementById('register-name');
        const registerClassInput = document.getElementById('register-class');
        const registerCodeInput = document.getElementById('register-code');
        const registerPasswordInput = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const registerMessage = document.getElementById('register-message');
        const backToLoginButton = document.getElementById('back-to-login');
        const livesContainer = document.getElementById('lives-container');
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        const finalMessageEl = document.getElementById('final-message');
        
        // --- ESTADO DO JOGO ---
        let score = 0;
        let lives = 5;
        let startTime;
        let loggedInUser = null;
        let currentQuestionIndex = 0;
        let shuffledQuestions = [];

        // --- BANCO DE PERGUNTAS ---
        const questions = [
            { question: 'Na frase "O menino chegou cedo", a palavra em destaque √© um adv√©rbio de:', options: ['Tempo', 'Lugar', 'Modo', 'Intensidade'], answer: 'Tempo' },
            { question: 'Qual das palavras abaixo √© um adv√©rbio de lugar?', options: ['L√°', 'Bem', 'Muito', 'Amanh√£'], answer: 'L√°' },
            { question: 'Na frase "Ela canta bem", a palavra "bem" classifica-se como adv√©rbio de:', options: ['Modo', 'Nega√ß√£o', 'D√∫vida', 'Tempo'], answer: 'Modo' },
            { question: '"Comi demais no almo√ßo." O adv√©rbio em destaque indica:', options: ['Intensidade', 'Afirma√ß√£o', 'Lugar', 'Modo'], answer: 'Intensidade' },
            { question: 'Qual palavra √© um adv√©rbio de nega√ß√£o?', options: ['N√£o', 'Sim', 'Talvez', 'Aqui'], answer: 'N√£o' },
            { question: 'Na frase "Eu sempre estudo antes das provas", qual √© o adv√©rbio?', options: ['sempre', 'estudo', 'provas', 'antes'], answer: 'sempre' },
            { question: 'O adv√©rbio "talvez" indica:', options: ['D√∫vida', 'Certeza', 'Tempo', 'Lugar'], answer: 'D√∫vida' },
            { question: 'Em "O cachorro latiu muito", a palavra "muito" √© um adv√©rbio de:', options: ['Intensidade', 'Modo', 'Lugar', 'Tempo'], answer: 'Intensidade' },
            { question: 'Qual frase cont√©m um adv√©rbio de modo?', options: ['A menina andava devagar.', 'O sol brilha hoje.', 'O livro est√° aqui.', 'Eu comi pouco.'], answer: 'A menina andava devagar.' },
            { question: '"Ele certamente vir√°." A palavra "certamente" √© um adv√©rbio de:', options: ['Afirma√ß√£o', 'Nega√ß√£o', 'D√∫vida', 'Modo'], answer: 'Afirma√ß√£o' }
        ];

        // --- FUN√á√ïES GERAIS E DE TELA ---
        function showScreen(screenToShow) {
            [loginScreen, videoScreen, gameScreen, endScreen].forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');
        }

        function toggleButtonLoader(button, show) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.loader');
            if (buttonText && loader) {
                buttonText.style.display = show ? 'none' : 'inline';
                loader.style.display = show ? 'inline-block' : 'none';
            }
            button.disabled = show;
        }

        async function callAppsScript(action, data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify({ action, ...data })
                });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                return await response.json();
            } catch (error) {
                console.error("Erro ao contatar o Apps Script:", error);
                return { status: 'error', message: 'Falha de comunica√ß√£o. Verifique sua conex√£o.' };
            }
        }

        function capitalizeName(name) {
            return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function handleSuccessfulLogin(userData) {
            const firstName = userData.name.split(' ')[0];
            loggedInUser = { ...userData, firstName };
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            showScreen(videoScreen);
        }

        // --- L√ìGICA DE LOGIN E CADASTRO ---
        loginButton.addEventListener('click', async () => {
            const code = loginCodeInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginMessage.textContent = '';
            if (!code || !password) {
                loginMessage.textContent = 'Preencha o c√≥digo e a senha.';
                return;
            }
            toggleButtonLoader(loginButton, true);
            const result = await callAppsScript('login', { code, password });
            toggleButtonLoader(loginButton, false);
            if (result.status === 'success') {
                handleSuccessfulLogin({ name: result.name, code: code, turma: result.turma });
            } else if (result.status === 'not_found') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerCodeInput.value = code;
                registerCodeInput.removeAttribute('readonly');
            } else {
                loginMessage.textContent = result.message || 'Ocorreu um erro.';
            }
        });
        
        goToRegisterButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            loginMessage.textContent = '';
            registerCodeInput.removeAttribute('readonly');
            registerCodeInput.value = '';
        });

        registerButton.addEventListener('click', async () => {
            const rawName = registerNameInput.value.trim();
            const turma = registerClassInput.value;
            const code = registerCodeInput.value.trim();
            const password = registerPasswordInput.value.trim();
            registerMessage.textContent = '';
            if (!rawName || !turma || !code || !password) {
                registerMessage.textContent = 'Todos os campos s√£o obrigat√≥rios.';
                return;
            }
            const name = capitalizeName(rawName);
            toggleButtonLoader(registerButton, true);
            const data = { name, turma, code, password };
            const result = await callAppsScript('register', data);
            toggleButtonLoader(registerButton, false);
            if (result.status === 'success') {
                handleSuccessfulLogin({ name: name, code: code, turma: turma });
            } else {
                registerMessage.textContent = result.message || 'Ocorreu um erro.';
            }
        });

        backToLoginButton.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            registerMessage.textContent = '';
        });
        
        // Event listeners for Enter key
        loginPasswordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginButton.click(); });
        loginCodeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginButton.click(); });
        registerPasswordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });
        registerCodeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });
        registerNameInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });

        window.addEventListener('load', () => {
            const user = sessionStorage.getItem('loggedInUser');
            if (user) {
                loggedInUser = JSON.parse(user);
                showScreen(videoScreen);
            } else {
                showScreen(loginScreen);
            }
            updateScoreDisplay();
        });

        // --- L√ìGICA DO V√çDEO ---
        let player;
        let progressCheckInterval;
        let maxWatchedTime = 0;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '3qXiMxTuDq8',
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady(event) { maxWatchedTime = 0; }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                clearInterval(progressCheckInterval); 
                progressCheckInterval = setInterval(() => {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    const isMuted = player.isMuted();
                    const playbackRate = player.getPlaybackRate();
                    const scoreTextEl = videoScreen.querySelector('.score-display').parentElement;

                    if (currentTime > maxWatchedTime + 1.5) {
                        player.seekTo(maxWatchedTime, true);
                    } else if (currentTime > maxWatchedTime) {
                        maxWatchedTime = currentTime;
                    }
                    
                    if (isMuted || playbackRate !== 1) {
                        score = 0;
                        scoreTextEl.classList.add('text-red-500');
                    } else {
                        scoreTextEl.classList.remove('text-red-500');
                        if (duration > 0) {
                            const potentialScore = (maxWatchedTime / duration) * 200;
                            score = Math.floor(potentialScore / 10) * 10;
                        }
                    }
                    updateScoreDisplay();

                    if ((maxWatchedTime / duration) >= 0.9) {
                        if (continueBtn.disabled) {
                            continueBtn.disabled = false;
                            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }, 500);
            } else {
                clearInterval(progressCheckInterval);
            }
        }

        continueBtn.addEventListener('click', () => {
            if (!continueBtn.disabled) {
                showScreen(gameScreen);
                startGame();
            }
        });

        // --- FUN√á√ïES DE UI DO JOGO ---
        function updateScoreDisplay() {
            document.querySelectorAll('.score-display').forEach(el => el.textContent = score);
        }
        
        function updateLivesDisplay() {
            livesContainer.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                livesContainer.innerHTML += '<span class="heart">‚ù§Ô∏è</span>';
            }
        }

        // --- L√ìGICA DO QUIZ ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            player.stopVideo();
            lives = 5;
            currentQuestionIndex = 0;
            shuffledQuestions = shuffleArray([...questions]);
            startTime = new Date();
            updateLivesDisplay();
            updateScoreDisplay();
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                endGame();
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionContainer.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';

            const shuffledOptions = shuffleArray([...currentQuestion.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button', 'w-full', 'bg-white', 'text-sky-700', 'text-lg', 'sm:text-xl', 'font-bold', 'py-4', 'px-2', 'rounded-xl', 'shadow-lg', 'border-b-8', 'border-sky-300', 'hover:border-sky-400');
                button.addEventListener('click', handleAnswer);
                optionsContainer.appendChild(button);
            });
        }

        function handleAnswer(e) {
            const selectedOption = e.target.textContent;
            const correctAnwer = shuffledQuestions[currentQuestionIndex].answer;

            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnwer) {
                score += 10;
                showFeedback('Correto! üéâ', true);
                e.target.classList.remove('bg-white', 'border-sky-300');
                e.target.classList.add('bg-green-400', 'border-green-600', 'text-white');
            } else {
                lives--;
                showFeedback('Ops, n√£o foi dessa vez! ü§î', false);
                e.target.classList.remove('bg-white', 'border-sky-300');
                e.target.classList.add('bg-red-400', 'border-red-600', 'text-white');
                 if (lives <= 0) {
                    setTimeout(endGame, 1500);
                    return;
                }
            }
            
            updateScoreDisplay();
            updateLivesDisplay();
            currentQuestionIndex++;
            
            setTimeout(displayNextQuestion, 1500);
        }

        function showFeedback(message, isCorrect) {
            feedbackEl.textContent = message;
            feedbackEl.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 sm:p-8 rounded-2xl text-white text-2xl sm:text-3xl font-bold shadow-2xl opacity-0 pointer-events-none w-11/12 max-w-sm text-center ${isCorrect ? 'bg-green-500' : 'bg-red-500'}`;
            feedbackEl.classList.remove('opacity-0');
            feedbackEl.style.transform = 'translate(-50%, -50%) scale(1)';
            setTimeout(() => {
                feedbackEl.style.transform = 'translate(-50%, -50%) scale(0.5)';
                feedbackEl.classList.add('opacity-0');
            }, 1000);
        }
        
        function getMotivationalMessage(finalScore) {
            if (finalScore >= 250) {
                return "Excelente, " + loggedInUser.firstName + "! Voc√™ √© um mestre dos adv√©rbios! üèÜ";
            } else if (finalScore >= 150) {
                return "Muito bem, " + loggedInUser.firstName + "! Continue praticando para ficar ainda melhor. üëç";
            } else {
                return "N√£o desista, " + loggedInUser.firstName + "! Cada tentativa √© um passo para aprender mais. ‚ú®";
            }
        }

        // --- L√ìGICA DE FIM DE JOGO E RANKING ---
        async function endGame() {
            const endTime = new Date();
            const timeSpent = Math.round((endTime - startTime) / 1000);
            
            showScreen(endScreen);
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-time').textContent = `${timeSpent}s`;
            finalMessageEl.textContent = getMotivationalMessage(score);
            
            document.getElementById('ranking-body').innerHTML = `<tr><td colspan="4" class="p-8 text-center"><div class="loader mx-auto"></div></td></tr>`;

            const result = await callAppsScript('saveScoreAndGetRanking', { 
                fullName: loggedInUser.name,
                turma: loggedInUser.turma, 
                score: score, 
                time: timeSpent,
                nomeDoJogo: NOME_DESTE_JOGO,
                code: loggedInUser.code
            });
            
            if (result.status === 'success') {
                populateRankingTable(result.ranking);
            } else {
                document.getElementById('ranking-body').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${result.message}</td></tr>`;
            }
        }
        
        function populateRankingTable(ranking) {
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = '';
            ranking.forEach((entry, index) => {
                const isCurrentUser = entry.code === loggedInUser.code;
                const row = `
                    <tr class="border-b border-sky-100 ${isCurrentUser ? 'bg-yellow-200' : ''}">
                        <td class="p-2 font-bold">${index + 1}</td>
                        <td class="p-2">${entry.name}</td>
                        <td class="p-2">${entry.score}</td>
                        <td class="p-2">${entry.turma}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        document.getElementById('play-again-button').addEventListener('click', () => {
            window.location.reload();
        });

    </script>
</body>
</html>
